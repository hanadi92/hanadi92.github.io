<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Webserver on OCI for free</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Deploying a Webserver on K3s with OCI for free!" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Etch</a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/tech.html">tech</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/webserver-on-oci.html" rel="bookmark"
           title="Permalink to Webserver on OCI for free">Webserver on OCI for free</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-12-24T10:07:00+01:00">
                Published: Sun 24 December 2023
        </abbr>
		<br />
        <abbr class="modified" title="2023-12-24T10:07:00+01:00">
                Updated: Sun 24 December 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hanadi.html">Hanadi</a>
        </address>
<p>In <a href="/category/tech.html">tech</a>.</p>
<p>tags: <a href="/tag/oci.html">OCI</a> <a href="/tag/k3s.html">K3s</a> <a href="/tag/webserver.html">webserver</a> </p>
</footer><!-- /.post-info -->      <p>I recently found out that OCI (Oracle Cloud Infrastructure) offers forever-free instances. So I thought, why not try to
deploy a webserver on those.</p>
<div class="section" id="oci-setup">
<h2>OCI Setup</h2>
<p>After signing up on <a class="reference external" href="https://www.oracle.com/cloud/">OCI</a>, it is pretty much intuitive to create a forever-free instance.
You can choose the placement, the used image, the shape of it, and get the ssh keys to connect later (IMPORTANT!).
It takes some seconds before the instance is up and running.</p>
<p>P.S. I chose an <tt class="docutils literal">arm</tt> based instance, since K3s requires that architecture.</p>
</div>
<div class="section" id="domain-optional">
<h2>Domain (Optional)</h2>
<p>At this point, OCI sets and provides a public IP for the instance. You may register a new domain and assign it to the public IP.</p>
</div>
<div class="section" id="k3s">
<h2>K3s</h2>
<p>I chose K3s because it needs and consumes less resources as other distributions (K8s, minikube, MikroK8s). It has an easy installation guide,
but here are some of my &quot;I wish I knew before...&quot;.</p>
<p>I always prefer to use the kubeconfig to access my cluster locally with LensIDE. Therefore, when I used the basic installation command to install k3s,
the kubeconfig certificate was not valid for the public IP of the instance, rather only for the local network IP.
The fix here was to add the parameter <tt class="docutils literal"><span class="pre">--tls-san</span> <span class="pre">public-ip</span></tt> in the <tt class="docutils literal">INSTALL_K3S_EXEC</tt> variable.</p>
<p>It would look something like this:</p>
<div class="highlight"><pre><span></span>curl<span class="w"> </span>-sfL<span class="w"> </span>https://get.k3s.io<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">INSTALL_K3S_EXEC</span><span class="o">=</span><span class="s2">&quot;--tls-san instance-public-ip --disable traefik&quot;</span><span class="w"> </span>sh<span class="w"> </span>-
</pre></div>
<dl class="docutils">
<dt>notes:</dt>
<dd>I am more comfortable with ingress NGINX and use it as LoadBalancer. So I just disabled traefik.
K3s dumps the kubeconfig under /etc/rancher/k3s/k3s.yaml
K3s installs helm in the cluster by default</dd>
</dl>
</div>
<div class="section" id="fluxcd-optional">
<h2>FluxCD (Optional)</h2>
<p><a class="reference external" href="https://fluxcd.io/">FluxCD</a> is definitely optional, but trust me you want it!
The most valuable feature is that you would push changes into git and it would just deploy it to your cluster (sync cluster state to git state).
Since K3s installs Helm by default on the cluster, you can install Flux on the instance machine:</p>
<div class="highlight"><pre><span></span>curl<span class="w"> </span>-s<span class="w"> </span>https://fluxcd.io/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash
</pre></div>
<p>then use helm or flux to install it on the cluster.
You would definitely need to give Flux access to your git repository (e.g. Github) aka <a class="reference external" href="https://fluxcd.io/flux/cmd/flux_bootstrap_github/">bootstrap</a>.
Prepare a Personal Access Token for it through your Github account, and give it permission to push into the repo.</p>
<p>It would look something like this (e.g. the git repo is personal and private on Github):</p>
<div class="highlight"><pre><span></span>flux<span class="w"> </span>bootstrap<span class="w"> </span>github<span class="w"> </span>--owner<span class="o">=</span>&lt;user&gt;<span class="w"> </span>--repository<span class="o">=</span>&lt;repository<span class="w"> </span>name&gt;<span class="w"> </span>--private<span class="o">=</span><span class="nb">false</span><span class="w"> </span>--personal<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--path<span class="o">=</span>clusters/my-cluster
</pre></div>
<p>The CLI will then ask for the access token. That command would push into the repo under that specified path some kustomization yaml to do its magic.</p>
</div>
<div class="section" id="ingress-nginx">
<h2>Ingress NGINX</h2>
<p>In case you disabled Traefik as I did, you would need an ingress controller and probably a load-balancer service. So my choice is ingress NGINX.
Since we have helm on the K3s, we could simply install ingress NGINX with helm:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>ingress-nginx<span class="w"> </span>ingress-nginx<span class="w"> </span>--repo<span class="w"> </span>https://kubernetes.github.io/ingress-nginx<span class="w"> </span>--namespace<span class="w"> </span>ingress-nginx<span class="w"> </span>--create-namespace<span class="w"> </span>--kubeconfig<span class="o">=</span>/etc/rancher/k3s/k3s.yaml
</pre></div>
<p>Now we can define a load-balancer service something like this:</p>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-nginx-controller</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">  </span><span class="nt">externalIPs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance-public-ip</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app.kubernetes.io/component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">controller</span>
<span class="w">    </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
</pre></div>
<p>If you have FluxCD, pushing this into the repo it would deploy the load-balancer service. Otherwise, use this command:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>the-load-balancer-service-file.yaml
</pre></div>
</div>
<div class="section" id="webserver-application">
<h2>Webserver (Application)</h2>
<p>As a proof of concept, I chose to set up a template webserver using Vite - VueJS.
This webserver has a dockerfile that is built and pushed into the github image registry (package) of the repo.
The image is then pulled from a deployment in the K3s cluster.</p>
<p>I assume you have nodejs (includes npm) on your (local) machine. The following creates a template Vue app.</p>
<div class="highlight"><pre><span></span>npm<span class="w"> </span>install<span class="w"> </span>create-vite
npm<span class="w"> </span>create<span class="w"> </span>vite@latest<span class="w"> </span>my-vue-app<span class="w"> </span>--<span class="w"> </span>--template<span class="w"> </span>vue
<span class="nb">cd</span><span class="w"> </span>my-vue-app
npm<span class="w"> </span>install
npm<span class="w"> </span>run<span class="w"> </span>serve
<span class="c1"># use browser to go wherever the cli tells you to</span>
</pre></div>
<p>Now we dockerize the building the Vue app using node image and serving it using an nginx image:</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">node:lts-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">build-stage</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>install
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>build

<span class="c"># production stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">nginx:stable-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">production-stage</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>build-stage<span class="w"> </span>/app/dist<span class="w"> </span>/usr/share/nginx/html
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">80</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;nginx&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-g&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;daemon off;&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="github-actions">
<h2>Github Actions</h2>
<p>In order to build that Dockerfile image and push into Github to pull it later from the cluster, we need the following github action workflow:</p>
<p>note that the actions have to have permission to access the repository from <tt class="docutils literal"><span class="pre">repo-&gt;settings-&gt;actions-&gt;access</span></tt></p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build and Push Image</span>
<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">workflow_dispatch</span><span class="p">:</span><span class="w"> </span><span class="c1"># to manually trigger it</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build-and-push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">      </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">      </span><span class="nt">packages</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout code</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Docker Buildx</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/setup-buildx-action@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux/arm64</span><span class="w">  </span><span class="c1"># IMPORTANT IF YOU CHOOSE ARM INSTANCE IN OCI</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Log in to GitHub container registry</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/login-action@v1.10.0</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io</span>
<span class="w">          </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.actor }}</span>
<span class="w">          </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.token }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build and push container image to registry</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...path-to-the-vue-app</span>
<span class="w">          </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/webserver:${{ github.sha }}</span>
<span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...path-to-the-dockerfile</span>
<span class="w">          </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux/arm64</span><span class="w">  </span><span class="c1"># IMPORTANT IF YOU CHOOSE ARM INSTANCE IN OCI</span>
</pre></div>
<p>When this workflow succeeds, it would create the docker image as a package under the repo packages.</p>
</div>
<div class="section" id="webserver-deployment-secret">
<h2>Webserver (Deployment &amp; Secret)</h2>
<p>Now we need to pull the docker image from the cluster. We need a deployment that points to the image that the workflow built <tt class="docutils literal"><span class="pre">ghcr.io/webserver:${{</span> github.sha }}</tt>.
However, since this image is in a private registry we need a secret that includes the base46 of a github access token (that you need to generate) to be able to pull it. So in this article I will provide the secret structure, but it is more secure
to use sealed-secrets (using <tt class="docutils literal">kubeseal</tt>) instead of normal secrets objects.
So these are the needed steps:</p>
<ol class="arabic simple">
<li>Generate an access token that has <tt class="docutils literal">packages:read</tt> permission</li>
<li>Use this command to decode it with base64:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;your-github-username:github-access-token&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;{&quot;auths&quot;:{&quot;ghcr.io&quot;:{&quot;auth&quot;:&quot;the-value-from-the-previous-command&quot;}}}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
</pre></div>
<ol class="arabic simple" start="3">
<li>Add the value to this secret object:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/dockerconfigjson</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github-secret</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-ns</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-name</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">.dockerconfigjson</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">the-value-from-last-command</span>
</pre></div>
<ol class="arabic simple" start="4">
<li>If you have FluxCD, pushing this into the repo would deploy the load-balancer service. Otherwise, use this command:</li>
</ol>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>the-secret-file.yaml
</pre></div>
<ol class="arabic simple" start="4">
<li>Create the deployment to pull the image for the webserver:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-deployment</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-ns</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/webserver:${{ github.sha }}</span><span class="w"> </span><span class="c1"># name of the image that you get under packages (copy the arm one)</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">            </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github-secret</span>
</pre></div>
<ol class="arabic simple" start="5">
<li>Create a service to expose an IP and port for the webserver deployment:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-service</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-ns</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
<ol class="arabic simple" start="6">
<li>Create an ingress to define a path and host for the webserver deployment:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-ns</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">your-domain-or-public-ip</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
<p>At this point, the webserver should be running on <tt class="docutils literal"><span class="pre">your-domain-or-public-ip</span></tt>! ... without https though.</p>
</div>
<div class="section" id="cert-manager-bonus">
<h2>Cert Manager (Bonus!)</h2>
<p>If you prefer to have https connections, you need a tls/ssl certificate on your <tt class="docutils literal"><span class="pre">your-domain-or-public-ip</span></tt>.
One of the nicest things in the world, is the <a class="reference external" href="https://cert-manager.io/">Cert Manager</a>.
All you have to do is to install the controller in your cluster and define certificates for your services.
It would manage the certificates and the challenges without any worries.
We follow these steps to certify our POC webserver:</p>
<ol class="arabic simple">
<li>Create a namespace and a ClusterIssuer object:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-ns</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-ns</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clusterIssuer</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
<span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">an-email-addree</span>
<span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-beta</span>
<span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http01</span><span class="p">:</span><span class="w"> </span><span class="c1"># this is http challenge. I don&#39;t cover other challenges in this article.</span>
<span class="w">        </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</pre></div>
<ol class="arabic simple" start="2">
<li>Create a certificate for the webserver deployment:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Certificate</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-cert</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-cert-secret</span>
<span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clusterIssuer</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
<span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">your-domain-or-public-ip</span>
</pre></div>
<ol class="arabic simple" start="3">
<li>Modify the webserver-ingress, add these values:</li>
</ol>
<div class="highlight"><pre><span></span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clusterIssuer</span>

<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">your-domain-or-public-ip</span>
<span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver-cert</span>
</pre></div>
<p>Tada! after some seconds, you can access your webserver on <tt class="docutils literal"><span class="pre">your-domain-or-public-ip</span></tt> with https.</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/hanadi92">@github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>